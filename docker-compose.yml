version: '3'

services:
  # 1. Zookeeper (Confluent 이미지 사용)
  zookeeper-0:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper-0
    ports:
      - 2181:2181
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  # 2. Kafka (Confluent 이미지 사용 - 100% 실행 보장)
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    depends_on:
      - zookeeper-0
    ports:
      - 9094:9094 # 외부 접속 (localhost:9094)
      - 9092:9092 # 내부 접속
    environment:
      # Confluent 설정 (Zookeeper 모드 자동 활성화)
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-0:2181
      
      # 리스너 설정
      # INTERNAL: 컨테이너 간 통신 (backend -> kafka:9092)
      # EXTERNAL: 외부 호스트 접속 (로컬 PC -> localhost:9094)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      
      # 단일 브로커 실행을 위한 필수 설정 (복제 계수 1)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1

  producers:
    build:
      context: ./producers
    container_name: producers
    restart: always
    command: python producer_with_AI.py
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      # 코드를 수정하면 바로 반영되도록 볼륨 연결
      - ./producers:/app
    depends_on:
      - kafka
    env_file:
      - .env

  # 3. Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka
    ports:
      - 8080:8080
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:9092

  # [추가] Flink JobManager (관리자)
  flink-jobmanager:
    build: ./flink-apps
    ports:
      - "8081:8081" # 웹 대시보드 포트
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
    volumes:
      - ./flink-apps:/opt/flink/usrlib # 코드 동기화
    depends_on:
      - kafka
      - postgres
    env_file:
      - .env

  # [추가] Flink TaskManager (일꾼)
  flink-taskmanager:
    build: ./flink-apps
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
    volumes:
      - ./flink-apps:/opt/flink/usrlib
    depends_on:
      - flink-jobmanager
    env_file:
      - .env

  # 4. Backend
  backend:
    container_name: backend
    build:
      context: ./back-end
    ports:
      - "8000:8000"
    command: python manage.py runserver 0.0.0.0:8000
    env_file:
      - .env
    volumes:
      - ./back-end:/app
    depends_on:
      - kafka

  postgres:
    container_name: postgres
    image: postgres:15
    restart: always
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ssafyuser
      POSTGRES_PASSWORD: ssafy
      POSTGRES_DB: postgres

  # 5. Frontend
  frontend:
    container_name: frontend
    build:
      context: ./front-end
    ports:
      - "80:80"
    depends_on:
      - backend

  # -- 웹소켓 내용
  websocket-server:
    image: python:3.9-slim
    depends_on:
      - kafka
    volumes:
      - ./server.py:/app/server.py  # 로컬의 server.py를 컨테이너 내부로 맵핑
    working_dir: /app
    ports:
      - "8765:8765" # 브라우저가 접속할 포트
    command: >
      bash -c "pip install websockets kafka-python && python server.py"

  kis-producers:
    build: ./back-end
    command: python kis_producer.py  # 루트에 있는 독립 파일
    volumes:
        - .:/app
    env_file:
        - .env
    depends_on:
        - kafka
    restart: on-failure  # Kafka 켜질 때까지 재시도

networks:
  default:
    name: de-project-network

